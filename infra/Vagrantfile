# -*- mode: ruby -*-
# vi: set ft=ruby :
#
# Vagrantfile - Cluster Docker Swarm pour GLPI
# Provisionné via Terraform (local-exec)
#

NODE_COUNT = ENV['TF_VAR_node_count'] || 3
BOX_IMAGE  = "bento/ubuntu-22.04"

Vagrant.configure("2") do |config|
  config.vm.box = BOX_IMAGE

  # Si le .box local existe, l'utiliser comme cache
  if File.exist?(File.join(File.dirname(__FILE__), "virtualbox.box"))
    config.vm.box_url = "file://" + File.join(File.dirname(__FILE__), "virtualbox.box")
  end

  # Désactiver le dossier partagé par défaut (pas nécessaire)
  config.vm.synced_folder ".", "/vagrant", disabled: true

  # Timeout de boot plus long (10 min au lieu de 5)
  config.vm.boot_timeout = 600

  (1..NODE_COUNT.to_i).each do |i|
    config.vm.define "glpi-node-#{sprintf('%02d', i)}" do |node|
      node.vm.hostname = "glpi-node-#{sprintf('%02d', i)}"

      # Réseau host-only avec IP statique (évite les problèmes de DHCP)
      node.vm.network "private_network", ip: "192.168.56.#{100 + i}"

      node.vm.provider "virtualbox" do |vb|
        vb.name   = "glpi-node-#{sprintf('%02d', i)}"
        vb.memory = 2048
        vb.cpus   = 2
        vb.gui    = false

        # Optimisation : désactiver les features inutiles
        vb.customize ["modifyvm", :id, "--audio", "none"]
        vb.customize ["modifyvm", :id, "--usb", "off"]
      end

      # Activer l'accès SSH par mot de passe (pour le déploiement initial de clés)
      node.vm.provision "shell", inline: <<-SHELL
        sed -i 's/^#\\?PasswordAuthentication.*/PasswordAuthentication yes/' /etc/ssh/sshd_config
        systemctl restart ssh
      SHELL
    end
  end
end
